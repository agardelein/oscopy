;; -*- Scheme -*-
;;
;; $Id$
;;
;; Copyright (C) 2010 - 2013 Arnaud Gardelein
;;
;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation; either version 2 of the License, or
;; (at your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with this program; if not, write to the Free Software
;; Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
;;
;;

(define oscopy:bindir "@BINDIR@")
(define oscopy:pythonpath "@PYEXECDIR@")

(define oscopy:oscopy-cmd-list
  (let ((color-term (getenv "COLORTERM")))
    `(,(if color-term color-term "xterm") "-e" "'sh ioscopy'")))

(define oscopy:dbus-oscopy-is-running-cmd "dbus-send --print-reply --session --dest=org.freedesktop.Oscopy /org/freedesktop/Oscopy org.freedesktop.OscopyIFace.dbus_running")
(define oscopy:dbus-oscopy-update-cmd "dbus-send --print-reply --session --dest=org.freedesktop.Oscopy /org/freedesktop/Oscopy org.freedesktop.OscopyIFace.dbus_update")

;; Menu
(define (oscopy:about)
  (gschem-msg (string-append
               "This is the oscopy major mode for gschem\n"
               "oscopy.scm\n"
               "This is highly experimental\n"
               "You should save your work often\n"
               "and keep backup copies.  You have\n"
               "been warned.\n"
               )
              )
  )

(define (oscopy:is-running)
  (eq? (status:exit-val (system oscopy:dbus-oscopy-is-running-cmd)) 0))

(define (prepend-var-to-env-path path var)
  (setenv path (string-append var ":" (getenv path))))

(define (oscopy:run-oscopy)
  (and (prepend-var-to-env-path "PATH" oscopy:bindir)
       (setenv "PYTHONPATH"
               (string-append "/usr/local/lib/python3.4/site-packages/"
                              ":"
                              oscopy:pythonpath))
       (apply system* oscopy:oscopy-cmd-list)))

(define (oscopy:launch-oscopy)
  (if (oscopy:is-running)
      (if (gschem-confirm (string-append "An instance of oscopy is already running\n"
                                         "Launch anyway ?"))
          (oscopy:run-oscopy))
      (oscopy:run-oscopy)))

(define (oscopy:update-oscopy)
  (if (oscopy:is-running)
      (system oscopy:dbus-oscopy-update-cmd)
      (if (gschem-confirm (string-append "No running instance of oscopy\n"
                                         "Launch oscopy ?"))
          (oscopy:run-oscopy))))

(define oscopy:menu-items
  ;;  menu item name        menu action          menu stock icon
  `((,(N_ "_About...")      oscopy:about         "gtk-help")
    (,(N_ "_Launch oscopy") oscopy:launch-oscopy "gtk-execute")
    (,(N_ "_Update oscopy") oscopy:update-oscopy "gtk-execute")))

;;; Define Oscopy keymap
(global-set-key "<Shift>O A" 'oscopy:about)
(global-set-key "<Shift>O L" 'oscopy:launch-oscopy)
(global-set-key "<Shift>O U" 'oscopy:update-oscopy)

;;; Add Oscopy menu
(begin
  ;; (begin...) is necessary here for guile 2.0.
  ;; See 'info guile' "R6RS Incompatibilities" for information on bug related
  ;; to syntax-transformers in top-level programs (N_ is a syntax transformer)
  (add-menu (N_ "_Oscopy") oscopy:menu-items))
